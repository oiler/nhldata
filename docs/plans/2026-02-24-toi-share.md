# TOI% Column Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a TOI% column showing each skater's share of their team's 5v5 ice time — to the game page player tables, the skaters leaderboard, and the individual player game log.

**Architecture:** TOI% = `5 × player_toi_seconds / SUM(all_team_skaters_toi_in_game)`. Since exactly 5 skaters are on ice at every 5v5 second, dividing the team total by 5 recovers the actual game duration, and the ratio is the player's deployment fraction. Season-average TOI% is stored in `player_metrics` (computed in `build_league_db.py`) and used by the skaters leaderboard; per-game TOI% is computed via an inline SQL subquery for the game and player pages.

**Tech Stack:** SQLite (inline subquery), pandas (`groupby.transform`), Plotly Dash DataTable (`FormatTemplate.percentage`)

---

### Task 1: Add `avg_toi_share` to `player_metrics`

**Files:**
- Modify: `v2/browser/build_league_db.py`
- Modify: `v2/browser/tests/test_player_metrics.py`

---

**Step 1: Write the failing test**

Add to `v2/browser/tests/test_player_metrics.py` (after `test_wppi_traded_player_no_inflation`):

```python
def test_avg_toi_share():
    """
    10 FLA skaters per game (5 games each):
      5 high-TOI players: 600s/game each
      5 low-TOI  players: 300s/game each
    team_total = 5×600 + 5×300 = 4500s/game
    game_5v5   = 4500 / 5     =  900s
    high share = 600 / 900    =  2/3
    low  share = 300 / 900    =  1/3
    """
    conn = sqlite3.connect(":memory:")
    rows = []
    for game in range(1, 6):
        for pid in range(1, 6):    # high-TOI players
            rows.append({"playerId": pid, "team": "FLA", "gameId": game,
                         "position": "F", "toi_seconds": 600,
                         "height_in": 72, "weight_lbs": 198})
        for pid in range(6, 11):   # low-TOI players
            rows.append({"playerId": pid, "team": "FLA", "gameId": game,
                         "position": "F", "toi_seconds": 300,
                         "height_in": 72, "weight_lbs": 198})
    df = pd.DataFrame(rows)
    df.to_sql("competition", conn, index=False, if_exists="replace")
    build_player_metrics_table(conn)
    high = conn.execute(
        "SELECT avg_toi_share FROM player_metrics WHERE playerId = 1"
    ).fetchone()[0]
    low = conn.execute(
        "SELECT avg_toi_share FROM player_metrics WHERE playerId = 6"
    ).fetchone()[0]
    assert abs(high - 2/3) < 0.001, f"Expected 0.667, got {high}"
    assert abs(low  - 1/3) < 0.001, f"Expected 0.333, got {low}"
```

**Step 2: Run test to verify it fails**

```bash
cd /Users/jrf1039/files/projects/nhl
python -m pytest v2/browser/tests/test_player_metrics.py::test_avg_toi_share -v
```

Expected: FAIL with `OperationalError: no such column: avg_toi_share`

**Step 3: Implement `avg_toi_share` in `build_player_metrics_table`**

In `v2/browser/build_league_db.py`, locate the block after `eligible["wppi_plus"] = 100.0 * eligible["wppi"] / mean_wppi` and before the `out = eligible[...]` line.

Insert this block:

```python
    # avg_toi_share: mean of per-game (5 × player_toi / team_toi) across player's games
    game_team_toi = comp.groupby(["team", "gameId"])["toi_seconds"].transform("sum")
    comp_share = comp.copy()
    comp_share["toi_share"] = 5.0 * comp_share["toi_seconds"] / game_team_toi.where(game_team_toi > 0)
    avg_toi_share = (
        comp_share[comp_share["playerId"].isin(eligible.index)]
        .groupby("playerId")["toi_share"]
        .mean()
        .rename("avg_toi_share")
    )
    eligible = eligible.join(avg_toi_share)
```

Then update the `out =` line to include `avg_toi_share`:

```python
    out = eligible[["ppi", "ppi_plus", "wppi", "wppi_plus", "avg_toi_share"]].reset_index()
```

**Step 4: Run all player_metrics tests to verify they pass**

```bash
python -m pytest v2/browser/tests/test_player_metrics.py -v
```

Expected: All 9 tests PASS (8 existing + 1 new)

**Step 5: Run full test suite**

```bash
python -m pytest v2/browser/tests/ -v
```

Expected: All 24 tests PASS

---

### Task 2: Add per-game TOI% to game page player tables

**Files:**
- Modify: `v2/browser/pages/game.py`

---

**Step 1: Update `_PLAYERS_SQL`**

Replace the existing `_PLAYERS_SQL` string with:

```python
_PLAYERS_SQL = """
SELECT
    c.playerId,
    COALESCE(p.firstName || ' ' || p.lastName, 'Player ' || c.playerId) AS playerName,
    c.team,
    c.position,
    c.toi_seconds,
    5.0 * c.toi_seconds / NULLIF(tt.team_total, 0)                      AS toi_share,
    c.comp_fwd,
    c.comp_def,
    c.pct_vs_top_fwd,
    c.pct_vs_top_def
FROM competition c
LEFT JOIN players p ON c.playerId = p.playerId
JOIN (
    SELECT gameId, team, SUM(toi_seconds) AS team_total
    FROM competition
    WHERE position IN ('F', 'D')
    GROUP BY gameId, team
) tt ON c.gameId = tt.gameId AND c.team = tt.team
WHERE c.gameId = ? AND c.position IN ('F', 'D')
ORDER BY c.toi_seconds DESC
"""
```

**Step 2: Update `_make_position_table` to include TOI%**

In `_make_position_table`, add `"toi_share"` to the `columns` list after `"toi_display"`:

```python
    columns = [
        {"name": "Player",       "id": "playerName"},
        {"name": "5v5 TOI",      "id": "toi_display"},
        {"name": "TOI%",         "id": "toi_share", "type": "numeric", "format": FormatTemplate.percentage(1)},
        {"name": "OPP F TOI",    "id": "comp_fwd_display"},
        {"name": "OPP D TOI",    "id": "comp_def_display"},
        {"name": "vs Top Fwd %", "id": "pct_vs_top_fwd", "type": "numeric", "format": FormatTemplate.percentage(2)},
        {"name": "vs Top Def %", "id": "pct_vs_top_def", "type": "numeric", "format": FormatTemplate.percentage(2)},
    ]
    display_cols = [
        "playerName", "toi_display", "toi_share", "comp_fwd_display",
        "comp_def_display", "pct_vs_top_fwd", "pct_vs_top_def",
    ]
```

**Step 3: Run test suite**

```bash
python -m pytest v2/browser/tests/ -v
```

Expected: All 24 tests PASS (no page-level tests, just confirming no regressions)

**Step 4: Verify visually**

Start the app: `cd v2/browser && python app.py`

Open a game page (e.g. `/game/2024020001`). Confirm:
- "TOI%" column appears between "5v5 TOI" and "OPP F TOI"
- Values display as percentages (e.g. `22.5%`)
- Forwards and defensemen each have plausible values that sum to ~500% per team

---

### Task 3: Add season-average TOI% to skaters leaderboard + update glossary

**Files:**
- Modify: `v2/browser/pages/skaters.py`
- Modify: `v2/browser/app.py`

---

**Step 1: Add `avg_toi_share` to the skaters SQL**

In `v2/browser/pages/skaters.py`, find the `_SQL` string. Add `MAX(pm.avg_toi_share) AS avg_toi_share,` after the existing `MAX(pm.wppi_plus) AS wppi_plus,` line:

```sql
    MAX(pm.ppi)                                                          AS ppi,
    MAX(pm.ppi_plus)                                                     AS ppi_plus,
    MAX(pm.wppi)                                                         AS wppi,
    MAX(pm.wppi_plus)                                                    AS wppi_plus,
    MAX(pm.avg_toi_share)                                                AS avg_toi_share,
```

**Step 2: Add "TOI%" column to the DataTable**

In the `columns` list inside `layout()`, add after `toi_display`:

```python
{"name": "TOI%", "id": "avg_toi_share", "type": "numeric", "format": FormatTemplate.percentage(1)},
```

In `display_cols`, add `"avg_toi_share"` after `"toi_display"`:

```python
    display_cols = [
        "player_link", "team", "position", "games_played", "toi_display",
        "avg_toi_share",
        "ppi", "ppi_plus", "wppi", "wppi_plus",
        "avg_pct_vs_top_fwd", "avg_pct_vs_top_def",
        "comp_fwd_display", "comp_def_display",
    ]
```

**Step 3: Add TOI% to the glossary in `app.py`**

In `v2/browser/app.py`, in the `html.Dl([...])` block, add after the `wPPI+` entry and before `5v5 TOI/GP`:

```python
            html.Dt("TOI%"),
            html.Dd(
                "Share of the team's 5v5 ice time played by this skater per game. "
                "Computed as 5 × player_toi / team_total_5v5_toi per game, then averaged "
                "across the season. 20% means the skater played 1/5 of all available 5v5 ice time."
            ),
```

**Step 4: Run test suite**

```bash
python -m pytest v2/browser/tests/ -v
```

Expected: All 24 tests PASS

**Step 5: Rebuild the DB and verify visually**

```bash
cd /Users/jrf1039/files/projects/nhl
python v2/browser/build_league_db.py
```

Expected output includes: `player_metrics: N rows`

Start app and open `/skaters`. Confirm:
- "TOI%" column appears between "5v5 TOI/GP" and "PPI"
- Values are percentages in a plausible range (top players ~25–35%, depth players ~10–15%)
- Column is sortable and filterable (e.g. `> 0.20` returns top-deployment players)
- Glossary footer shows the new TOI% entry

---

### Task 4: Add per-game TOI% to player page + fix filter_options bug

**Files:**
- Modify: `v2/browser/pages/player.py`

---

**Step 1: Update `_GAMES_SQL` with the toi_share subquery**

Replace the existing `_GAMES_SQL` string with:

```python
_GAMES_SQL = """
SELECT c.gameId, g.gameDate, c.team,
       g.awayTeam_abbrev, g.homeTeam_abbrev,
       g.awayTeam_score, g.homeTeam_score,
       g.periodDescriptor_number,
       c.toi_seconds,
       5.0 * c.toi_seconds / NULLIF(tt.team_total, 0) AS toi_share,
       c.comp_fwd, c.comp_def,
       c.pct_vs_top_fwd, c.pct_vs_top_def
FROM competition c
JOIN games g ON c.gameId = g.gameId
JOIN (
    SELECT gameId, team, SUM(toi_seconds) AS team_total
    FROM competition
    WHERE position IN ('F', 'D')
    GROUP BY gameId, team
) tt ON c.gameId = tt.gameId AND c.team = tt.team
WHERE c.playerId = ?
ORDER BY g.gameDate ASC
"""
```

**Step 2: Add `toi_share` to the rows dict in `layout()`**

In the `rows.append({...})` block, add after `"toi_display"`:

```python
            "toi_share":      round(float(r["toi_share"]), 4) if r["toi_share"] is not None else None,
```

**Step 3: Add "TOI%" to the columns list**

In `columns`, add after `"toi_display"`:

```python
        {"name": "TOI%",         "id": "toi_share",       "type": "numeric", "format": FormatTemplate.percentage(1)},
```

**Step 4: Remove `filter_options` bug**

In the `dash_table.DataTable(...)` call, remove this line entirely:

```python
            filter_options={"case": "insensitive"},
```

Background: `filter_options={"case": "insensitive"}` is a known Dash bug (introduced in 2.13.0) that forces **all** columns — including `type: "numeric"` — to use text comparison, breaking `>`, `<`, `>=`, `<=` operators. Removing it restores native numeric filtering. The text columns (Date, Team, etc.) will still filter correctly using Dash's default behavior.

**Step 5: Run test suite**

```bash
python -m pytest v2/browser/tests/ -v
```

Expected: All 24 tests PASS

**Step 6: Verify visually**

Open any player page (e.g. `/player/8478402`). Confirm:
- "TOI%" column appears between "5v5 TOI" and "OPP F TOI"
- Values vary game-to-game (reflects deployment changes)
- Numeric filter works: type `> 0.20` in the TOI% filter box → returns high-deployment games
- vs Top Fwd %/Def % filters still work with `>` and `<`
