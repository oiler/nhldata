# 5v5 Points Per 60 — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Calculate 5v5 points (goals + assists) per 60 minutes of 5v5 ice time for each player per game, then display on the team page and skaters leaderboard.

**Architecture:** Extract 5v5 point events from flattened play-by-play CSVs during `build_league_db.py`, store per-game player point counts in a new `points_5v5` table, then compute P/60 at query time in the browser pages using: `points * 3600 / toi_seconds`.

**Tech Stack:** pandas, SQLite, existing `build_league_db.py` pipeline, Dash callbacks.

---

### Task 1: Add `points_5v5` table to `build_league_db.py`

**Files:**
- Modify: `v2/browser/build_league_db.py`

This task adds a new function that reads all flattened plays CSVs, extracts goal events at 5v5 situation codes (`1551`, `0651`, `1560`), counts goals and assists per player per game, and writes a `points_5v5` table.

---

**Step 1: Add the `build_points_5v5_table` function**

Add this function to `v2/browser/build_league_db.py`, before `main()`:

```python
FLATPLAYS_DIR = os.path.join(SEASON_DIR, "generated", "flatplays")
FIVE_V_FIVE = {"1551", "0651", "1560"}


def build_points_5v5_table(conn):
    """Extract 5v5 goals and assists from flattened plays, write per-game player point counts."""
    frames = []
    for path in sorted(glob.glob(os.path.join(FLATPLAYS_DIR, "*.csv"))):
        game_id = int(os.path.basename(path).replace(".csv", ""))
        df = pd.read_csv(path, low_memory=False)
        goals = df[
            (df["typeDescKey"] == "goal")
            & (df["situationCode"].astype(str).isin(FIVE_V_FIVE))
        ]
        if goals.empty:
            continue

        records = []
        for _, g in goals.iterrows():
            scorer = g.get("details.scoringPlayerId")
            a1 = g.get("details.assist1PlayerId")
            a2 = g.get("details.assist2PlayerId")
            if pd.notna(scorer):
                records.append({"gameId": game_id, "playerId": int(scorer), "goals": 1, "assists": 0})
            if pd.notna(a1):
                records.append({"gameId": game_id, "playerId": int(a1), "goals": 0, "assists": 1})
            if pd.notna(a2):
                records.append({"gameId": game_id, "playerId": int(a2), "goals": 0, "assists": 1})
        if records:
            frames.append(pd.DataFrame(records))

    if not frames:
        print("  points_5v5: 0 rows (no 5v5 goals found)")
        return
    out = pd.concat(frames, ignore_index=True)
    out = out.groupby(["gameId", "playerId"]).agg(
        goals=("goals", "sum"),
        assists=("assists", "sum"),
    ).reset_index()
    out["points"] = out["goals"] + out["assists"]
    out.to_sql("points_5v5", conn, if_exists="replace", index=False)
    print(f"  points_5v5: {len(out)} rows from {len(frames)} games")
```

**Step 2: Call it from `main()`**

Add `build_points_5v5_table(conn)` after `build_games_table(conn)` in `main()`:

```python
def main():
    ...
        build_competition_table(conn)
        build_players_table(conn)
        build_games_table(conn)
        build_points_5v5_table(conn)   # <-- new
        build_player_metrics_table(conn)
    ...
```

**Step 3: Rebuild the database and verify**

```bash
cd /Users/jrf1039/files/projects/nhl && python v2/browser/build_league_db.py
```

Then verify:
```bash
cd /Users/jrf1039/files/projects/nhl && python -c "
import sqlite3, pandas as pd
conn = sqlite3.connect('data/2025/generated/browser/league.db')
df = pd.read_sql_query('SELECT * FROM points_5v5 LIMIT 10', conn)
print(df)
print(f'Total rows: {pd.read_sql_query(\"SELECT COUNT(*) as n FROM points_5v5\", conn).iloc[0][\"n\"]}')
conn.close()
"
```

Expected: Table with columns `gameId`, `playerId`, `goals`, `assists`, `points`. Several thousand rows (one per player per game where they recorded a 5v5 point).

---

### Task 2: Add P/60 column to team page

**Files:**
- Modify: `v2/browser/pages/team.py`

Join `points_5v5` into the team page player stats, compute P/60 = `points * 3600 / toi_seconds`, and display it in the player tables.

---

**Step 1: Add a points query and join in the callback**

In `v2/browser/pages/team.py`, add a SQL constant after the existing ones:

```python
_POINTS_SQL = """
SELECT playerId, gameId, goals, assists, points
FROM points_5v5
"""
```

In the `update_team` callback, after computing `grouped` from `comp_df`, join the aggregated points:

```python
    # 5v5 points
    pts_df = league_query(_POINTS_SQL)
    if not pts_df.empty and not comp_df.empty:
        # Filter points to only games in the filtered comp_df
        valid_games = comp_df[["playerId", "gameId"]].drop_duplicates()
        pts_filtered = pts_df.merge(valid_games, on=["playerId", "gameId"], how="inner")
        pts_agg = pts_filtered.groupby("playerId").agg(
            total_goals=("goals", "sum"),
            total_assists=("assists", "sum"),
            total_points=("points", "sum"),
        )
        grouped = grouped.join(pts_agg)
    grouped["total_goals"] = grouped.get("total_goals", 0).fillna(0).astype(int)
    grouped["total_assists"] = grouped.get("total_assists", 0).fillna(0).astype(int)
    grouped["total_points"] = grouped.get("total_points", 0).fillna(0).astype(int)
    grouped["p_per_60"] = grouped["total_points"] * 3600 / grouped["total_toi"].where(grouped["total_toi"] > 0)
```

**Step 2: Add P/60 column to `_make_position_table`**

Add to the `columns` list in `_make_position_table`:

```python
        {"name": "G",     "id": "total_goals",   "type": "numeric"},
        {"name": "A",     "id": "total_assists",  "type": "numeric"},
        {"name": "P",     "id": "total_points",   "type": "numeric"},
        {"name": "P/60",  "id": "p_per_60",       "type": "numeric", "format": Format(precision=2, scheme=Scheme.fixed)},
```

Add to the `display_cols` list:

```python
        "total_goals", "total_assists", "total_points", "p_per_60",
```

**Step 3: Verify manually**

```bash
cd /Users/jrf1039/files/projects/nhl/v2/browser && python app.py
```

Open http://127.0.0.1:8050/team/EDM — verify G, A, P, P/60 columns appear in the Forwards and Defensemen tables with correct values.

---

### Task 3: Add P/60 column to skaters leaderboard

**Files:**
- Modify: `v2/browser/pages/skaters.py`

Same pattern as the team page — join points, compute P/60, add columns.

---

**Step 1: Add points query and join in the callback**

In `v2/browser/pages/skaters.py`, add a SQL constant:

```python
_POINTS_SQL = """
SELECT playerId, gameId, goals, assists, points
FROM points_5v5
"""
```

In the `update_skaters` callback, after computing `grouped`, join the aggregated points:

```python
    # 5v5 points
    pts_df = league_query(_POINTS_SQL)
    if not pts_df.empty and not comp_df.empty:
        valid_games = comp_df[["playerId", "gameId"]].drop_duplicates()
        pts_filtered = pts_df.merge(valid_games, on=["playerId", "gameId"], how="inner")
        pts_agg = pts_filtered.groupby("playerId").agg(
            total_goals=("goals", "sum"),
            total_assists=("assists", "sum"),
            total_points=("points", "sum"),
        )
        grouped = grouped.join(pts_agg)
    grouped["total_goals"] = grouped.get("total_goals", 0).fillna(0).astype(int)
    grouped["total_assists"] = grouped.get("total_assists", 0).fillna(0).astype(int)
    grouped["total_points"] = grouped.get("total_points", 0).fillna(0).astype(int)
    grouped["p_per_60"] = grouped["total_points"] * 3600 / grouped["total_toi"].where(grouped["total_toi"] > 0)
```

**Step 2: Add columns to the DataTable**

Add to the `columns` list:

```python
        {"name": "G",     "id": "total_goals",   "type": "numeric"},
        {"name": "A",     "id": "total_assists",  "type": "numeric"},
        {"name": "P",     "id": "total_points",   "type": "numeric"},
        {"name": "P/60",  "id": "p_per_60",       "type": "numeric", "format": Format(precision=2, scheme=Scheme.fixed)},
```

Add to the `display_cols` list:

```python
        "total_goals", "total_assists", "total_points", "p_per_60",
```

**Step 3: Verify manually**

Open http://127.0.0.1:8050/skaters — verify G, A, P, P/60 columns appear and values are correct. Sanity check: a player with 2 points in 600 seconds (10 min) of 5v5 TOI should show P/60 = 12.00.

---

### Task 4: Run full test suite

**Step 1: Run tests**

```bash
cd /Users/jrf1039/files/projects/nhl && python -m pytest v2/ -v
```

Expected: All existing tests still pass.

**Step 2: Manual smoke test**

Verify:
- `/skaters` — G, A, P, P/60 columns visible, values look reasonable
- `/team/EDM` — G, A, P, P/60 in both Forwards and Defensemen tables
- Changing date range or H/A toggle updates the point totals and P/60
- Players with 0 points show P/60 as 0 or blank, not errors
